<!doctype html>
<html lang="en">
	<head>
		<meta http-equiv="cache-control" content="max-age=0" />
		<meta http-equiv="cache-control" content="no-cache" />
		<meta http-equiv="expires" content="0" />
		<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
		<meta http-equiv="pragma" content="no-cache" />
		<meta charset="UTF-8">
		<title>Meme Invaders</title>
		<script src="js/helpers.js"></script>
		<style>
canvas {
	background: #000;
	display: block;
	position: absolute;
	margin: auto;
	top: 0;
	bottom: 0;
	right: 0;
	left: 0;
}
		</style>
	</head>
	<body>
		<script>
var screen, input, frames, spFrame, lvFrame;
var alSprite, taSprite, ciSprite;
var aliens, dir, tank, bullets, cities;

function main() {
	display = new Screen(595, 700);
	input = new InputHandler();

	var img = new Image();
	img.addEventListener('load', function() {
		alSprite = [
			[new Sprite(this, 5, 5, 32, 32), new Sprite(this, 5, 5, 32, 32)],
			[new Sprite(this, 5, 47, 32, 32), new Sprite(this, 5, 47, 32, 32)],
			[new Sprite(this, 5, 5, 32, 32), new Sprite(this, 5, 5, 32, 32)]
		];

			taSprite = new Sprite(this, 47, 5, 32, 32);
			ciSprite = new Sprite(this, 47, 47, 32, 32);

			init();
			run();
	});

	img.src = "../sprites/spritesheet.png";
};

function init() {
	frames = 0;
	spFrame = 0;
	lvFrame = 60;
	dir = 1;

	tank = {
		sprite: taSprite,
		x: (display.width - taSprite.w) / 2,
		y: display.height - (35 + taSprite.h)
	};

	bullets = [];

	aliens = [];
	var rows = [0, 1, 1, 2, 2];
	for (var i = 0, len = rows.length; i < len; i++) {
		for (var j = 0; j < 10; j++) {
			var a = rows[i];
			aliens.push({
				sprite: alSprite[a],
				x: 35 + j*35,
				y: 35 + i*35,
				w: alSprite[a][0].w,
				h: alSprite[a][0].h
			});
		}
	}
};

function run() {
	var loop = function() {
		update();
		render();
		window.requestAnimationFrame(loop, display.canvas);
	};
	window.requestAnimationFrame(loop, display.canvas);
};

function update() {
	if (input.isDown(37)) { // Left
			tank.x -= 4;
	}
	if (input.isDown(39)) { // Right
		tank.x += 4;
	}
	tank.x = Math.max(Math.min(tank.x, display.width - (35 + taSprite.w)), 35);

	for (var i = 0, len = bullets.length; i < len; i++) {
		bullets[i].update();
	}

	if (input.isDown(32)) { 
		bullets.push(new Bullet(tank.x + 10, tank.y, -8, 2, 6, "#fff"));
	}
	frames++;
	if (frames % lvFrame === 0) {
		spFrame = (spFrame + 1) % 2;

		var _max = 0, _min = screen.width;

		for (var i = 0, len = aliens.length; i < len; i++) {
			var a = aliens[i];
			a.x += 35 * dir;

			_max = Math.max(_max, a.x + a.w);
			_min = Math.min(_min, a.x);
		}
		if (_max > display.width - 35 || _min < 35) {
			dir *= -1;
			for (var i = 0, len = aliens.length; i < len; i++) {
				aliens[i].x += 35 * dir;
				aliens[i].y += 35;
			}
		}
	}
};

function render() {
	display.clear();
	for (var i = 0, len = aliens.length; i < len; i++) {
		var a = aliens[i];
		display.drawSprite(a.sprite[spFrame], a.x, a.y);
	}
	display.ctx.save();
	for (var i = 0, len = bullets.length; i < len; i++) {
		display.drawBullet(bullets[i]);
	}
	display.ctx.restore();
	display.drawSprite(tank.sprite, tank.x, tank.y);
};

main();

		</script>
	</body>
</html>

